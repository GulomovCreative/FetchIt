!function(){"use strict";class t{static forms=[];static instances=new Map;static events={before:"fetchit:before",success:"fetchit:success",error:"fetchit:error",after:"fetchit:after",reset:"fetchit:reset"};constructor(e,s){if(!(e instanceof HTMLFormElement))throw new Error("Не форма");this.form=e,this.config=s,this.request=new Request(this.config.actionUrl,{method:"post",credentials:"same-origin",headers:{Accept:"application/json","X-FetchIt-Action":this.config.action}}),this.prepareEvents(),t.forms.push(this.form),t.instances.set(this.form,this)}prepareEvents(){this.form.addEventListener("submit",(async e=>{e.preventDefault(),this.formData=new FormData(this.form),this.formData.set("pageId",this.config.pageId),this.clearErrors();const s=new CustomEvent(t.events.before,{cancelable:!0,detail:{form:this.form,formData:this.formData,fetchit:this}});if(t?.Message?.before?.(),document.dispatchEvent(s)){this.disableFields();try{const e=await fetch(this.request,{body:this.formData}),s=await e.json(),r=new CustomEvent(t.events.after,{cancelable:!0,detail:{form:this.form,formData:this.formData,response:s,fetchit:this}});if(t?.Message?.after?.(s.message),!document.dispatchEvent(r))return;if(!s.success){t?.Message?.error?.(s.message);const e=new CustomEvent(t.events.error,{cancelable:!0,detail:{form:this.form,formData:this.formData,response:s,fetchit:this}});if(!document.dispatchEvent(e))return;for(const[t,e]of Object.entries(s.data))this.setError(t,e);return}this.clearErrors(),t?.Message?.success?.(s.message);const i=new CustomEvent(t.events.success,{detail:{form:this.form,formData:this.formData,response:s,fetchit:this}});if(!document.dispatchEvent(i))return;void 0!==window.grecaptcha&&window.grecaptcha.reset(),this.config.clearFieldsOnSuccess&&this.form.reset()}catch(e){console.error(e)}finally{this.enableFields()}}})),this.form.addEventListener("reset",(()=>{const e=new CustomEvent(t.events.reset,{detail:{form:this.form,fetchit:this}});document.dispatchEvent(e),this.clearErrors(),t?.Message?.reset?.()})),["change","input"].forEach((t=>{this.form.addEventListener(t,(({target:t})=>{this.clearError(t.getAttribute("name"))}))}))}clearErrors(){this.fields.forEach((t=>this.clearError(t.getAttribute("name"))))}clearError(t){const e=this.getFields(t);e.forEach((t=>{this.inputInvalidClasses&&t.classList.remove(...this.inputInvalidClasses),t.removeAttribute("aria-invalid")}));const s=this.getErrors(t);s.forEach((t=>{t.style.display="none",t.innerHTML=""}));const r=this.getCustomErrors(t);return this.customInvalidClasses&&r.forEach((({classList:t})=>t.remove(...this.customInvalidClasses))),{fields:e,errors:s,customErrors:r}}setError(t,e=""){this.getFields(t).forEach((t=>{this.inputInvalidClasses&&t.classList.add(...this.inputInvalidClasses),t.setAttribute("aria-invalid",!0)})),this.customInvalidClasses&&this.getCustomErrors(t).forEach((({classList:t})=>t.add(...this.customInvalidClasses))),this.getErrors(t).forEach((t=>{t.style.display="",t.innerHTML=e}))}enableFields(){this.elements.forEach((t=>t.removeAttribute("disabled")))}disableFields(){this.elements.forEach((t=>t.setAttribute("disabled","")))}getFields(t){return t?Array.from(this.form.querySelectorAll(`[name="${t}"], [name="${t}[]"]`)):[]}getErrors(t){return t?Array.from(this.form.querySelectorAll(`[data-error="${t}"], [data-error="${t}[]"]`)):[]}getCustomErrors(t){return t?Array.from(this.form.querySelectorAll(`[data-custom="${t}"]`)):[]}get elements(){return Array.from(this.form.elements)}get fields(){return this.elements.filter((({tagName:t})=>["select","input","textarea"].includes(t.toLowerCase())))}get inputInvalidClasses(){return this.config.inputInvalidClass?this.config.inputInvalidClass.split(" "):[]}get customInvalidClasses(){return this.config.customInvalidClass?this.config.customInvalidClass.split(" "):[]}static sanitizeHTML(t=""){return t.replace(/(<([^>]+)>)/gi,"")}static create(e){if(e.defaultNotifier&&"function"==typeof window.Notyf&&void 0===t.Message){const e=new Notyf;t.Message={success(t){e.success(t)},error(t){e.error(t)}}}if(!e.action)throw new Error("Нет идентификатора формы FetchIt");const s=document.querySelectorAll(`form[data-fetchit="${e.action}"]`);if(!s)throw new Error(`В документе не найдено форм по селектору: form[data-fetchit="${e.action}"]`);s.forEach((t=>{new this(t,e)}))}}window.FetchIt=t}();
